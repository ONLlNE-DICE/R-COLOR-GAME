<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Color Game ðŸŽ²</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: linear-gradient(to bottom, #ffe066, #ffb347);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: 100vh;
    }

    h1 {
      text-align: center;
      color: #d80000;
      text-shadow: 2px 2px gold;
    }

    .container {
      display: flex;
      margin-top: 20px;
      gap: 40px;
    }

    .panel {
      border: 4px solid #007acc;
      background: white;
      padding: 15px;
      border-radius: 10px;
      min-width: 200px;
      min-height: 260px;
    }

    .panel h3 {
      margin-top: 0;
      text-align: center;
      color: #007acc;
    }

    .color-box {
      width: 20px;
      height: 20px;
      border: 1px solid #333;
      opacity: 0.9;
      margin-left: 5px;
    }

    .history-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .game-area {
      width: 320px;
      height: 300px;
      background: #fff;
      border: 8px solid #007acc;
      border-radius: 12px;
      position: relative;
      perspective: 1000px;
      overflow: hidden;
    }

    .dice {
      width: 60px;
      height: 60px;
      position: absolute;
      top: 120px;
      transform-style: preserve-3d;
    }

    .face {
      position: absolute;
      width: 60px;
      height: 60px;
      opacity: 0.95;
      border: 1px solid #333;
    }

    .face.front  { background: red;    transform: rotateY(0deg) translateZ(30px); }
    .face.back   { background: violet; transform: rotateY(180deg) translateZ(30px); }
    .face.right  { background: blue;   transform: rotateY(90deg) translateZ(30px); }
    .face.left   { background: green;  transform: rotateY(-90deg) translateZ(30px); }
    .face.top    { background: white;  transform: rotateX(-90deg) translateZ(30px); }
    .face.bottom { background: yellow; transform: rotateX(90deg) translateZ(30px); }

    button {
      margin-top: 20px;
      font-size: 18px;
      padding: 10px 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .result {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
    }

    #riggedHint {
      width: 8px;
      height: 8px;
      background: gray;
      position: absolute;
      top: 8px;
      left: 8px;
      border-radius: 50%;
      opacity: 0.4;
      z-index: 9999;
      pointer-events: none;
    }

    #historyCountInput {
      margin-top: 10px;
      width: 60px;
      padding: 5px;
      font-size: 14px;
    }

  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
</head>
<body>

<div id="riggedHint"></div>

<div>
  <h1>ðŸŽ² Color Game ðŸŽ²</h1>
  <div class="container">
    <div class="panel">
      <h3>Previous Rolls</h3>
      <label for="historyCountInput">Show:</label>
      <input id="historyCountInput" type="number" min="1" max="20" value="5" onchange="adjustHistoryCount()">
      <div id="historyBox" style="margin-top: 10px;"></div>
    </div>

    <div>
      <div class="game-area" id="gameArea"></div>
      <div class="result" id="resultText">Waiting for roll...</div>
      <button onclick="rollDice()">ROLL DICE</button>
    </div>

    <div class="panel">
      <h3>Current Roll</h3>
      <div id="currentBox" style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;"></div>
    </div>
  </div>
</div>

<script>
  const rotations = {
    Red: "rotateX(0deg) rotateY(0deg)",
    Violet: "rotateX(0deg) rotateY(180deg)",
    Blue: "rotateX(0deg) rotateY(-90deg)",
    Green: "rotateX(0deg) rotateY(90deg)",
    White: "rotateX(90deg) rotateY(0deg)",
    Yellow: "rotateX(-90deg) rotateY(0deg)"
  };

  const colors = ["Red", "Blue", "Green", "Yellow", "White", "Violet"];
  const gameArea = document.getElementById("gameArea");
  const resultText = document.getElementById("resultText");
  const historyBox = document.getElementById("historyBox");
  const currentBox = document.getElementById("currentBox");

  const firebaseConfig = {
    apiKey: "AIzaSyCX6bXyHJEdUFSZTq2tBqFYFYNv7FSxD8",
    authDomain: "color-game-135fb.firebaseapp.com",
    databaseURL: "https://color-game-135fb-default-rtdb.firebaseio.com",
    projectId: "color-game-135fb",
    storageBucket: "color-game-135fb.appspot.com",
    messagingSenderId: "362417900313",
    appId: "1:362417900313:web:765a79e4c95fa17936fa30"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const presetRef = db.ref("presetDice");
  const rollingRef = db.ref("isRolling");
  const historyRef = db.ref("history");

  let rigged = null;
  let history = [];
  let historyLimit = 5;

  presetRef.on("value", snap => {
    rigged = snap.val();
    const hintDot = document.getElementById("riggedHint");
    hintDot.style.background = (rigged && rigged.length > 0) ? "green" : "gray";
  });

  function createColorBox(color) {
    const div = document.createElement("div");
    div.className = "color-box";
    div.style.background = color.toLowerCase();
    return div;
  }

  function updateHistory(colors) {
    history.unshift(colors);
    if (history.length > historyLimit) history.length = historyLimit;
    historyBox.innerHTML = "";
    history.forEach((entry, idx) => {
      const row = document.createElement("div");
      row.className = "history-item";
      const label = document.createElement("span");
      label.textContent = `${idx + 1}.`;
      label.style.width = "20px";
      row.appendChild(label);
      entry.forEach(color => row.appendChild(createColorBox(color)));
      historyBox.appendChild(row);
    });

    // Push full history to Firebase
    historyRef.set(history);
  }

  function updateCurrent(colors) {
    currentBox.innerHTML = "";
    colors.forEach(color => currentBox.appendChild(createColorBox(color)));
  }

  function adjustHistoryCount() {
    const input = document.getElementById("historyCountInput");
    const value = parseInt(input.value);
    if (!isNaN(value) && value > 0) {
      historyLimit = value;
      updateHistory([]);
    }
  }

  async function rollDice() {
    gameArea.innerHTML = "";
    resultText.textContent = "ðŸŽ² Rolling...";
    await rollingRef.set(true);

    const results = rigged || [
      colors[Math.floor(Math.random() * colors.length)],
      colors[Math.floor(Math.random() * colors.length)],
      colors[Math.floor(Math.random() * colors.length)]
    ];

    results.forEach((color, i) => {
      const dice = document.createElement("div");
      dice.className = "dice";
      dice.style.left = `${60 + i * 70}px`;
      gameArea.appendChild(dice);

      ["front", "back", "right", "left", "top", "bottom"].forEach(face => {
        const f = document.createElement("div");
        f.className = `face ${face}`;
        dice.appendChild(f);
      });

      const baseRotation = rotations[color];
      const match = baseRotation.match(/rotateX\((-?\d+)deg\)\srotateY\((-?\d+)deg\)/);
      const x = parseInt(match[1]);
      const y = parseInt(match[2]);
      const finalRotation = `rotateX(${x + 720}deg) rotateY(${y + 720}deg)`;

      setTimeout(() => {
        dice.style.transition = "transform 1.5s ease-in-out";
        dice.style.transform = finalRotation;
      }, 50);
    });

    setTimeout(async () => {
      resultText.textContent = `ðŸŽ¯ Result: ${results.join(", ")}`;
      updateCurrent(results);
      updateHistory(results);
      await presetRef.set(null);
      await rollingRef.set(false);
    }, 1600);
  }
</script>
</body>
</html>
