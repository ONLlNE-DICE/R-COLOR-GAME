<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Roller Control Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #a5ceff;
            color: black;
            padding: 20px;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .wrapper {
            width: 90%;
            max-width: 600px;
            border: 5px solid white;
            background-color: #5ba7ff;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border-radius: 20px;
            position: relative;
            box-shadow: 0px 10px 20px rgba(0, 0, 0, 0.3);
        }

        .title {
            font-family: 'Luckiest Guy', cursive;
            font-size: 28px;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .section-title {
            font-family: 'Luckiest Guy', cursive;
            font-size: 22px;
            color: white;
            margin-top: 20px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }

        .control-group {
            background-color: #2d98ff;
            border-radius: 8px;
            padding: 10px;
            text-align: left;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: white;
        }

        .control-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .control-group .red { color: red; }
        .control-group .orange { color: orange; }
        .control-group .gold { color: gold; }
        .control-group .green { color: green; }
        .control-group .blue { color: blue; }
        .control-group .purple { color: purple; }
        .control-group .heads { color: green; }
        .control-group .tails { color: orange; }

        button {
            background: linear-gradient(to bottom, #ffeb3b, #ffc107);
            color: white;
            font-family: 'Luckiest Guy', cursive;
            padding: 10px 20px;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            border: 3px solid white;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0px 6px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            width: 100%;
            max-width: 300px;
            margin-top: 10px;
            -webkit-text-stroke: 0.2px #ca8a00;
        }

        button:hover {
            transform: scale(1.03);
            box-shadow: 0px 8px 10px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: scale(0.97);
            box-shadow: 0px 3px 5px rgba(0, 0, 0, 0.4);
        }

        #rollingStatus {
            margin-top: 20px;
            font-size: 20px;
            font-weight: bold;
            color: white;
        }

        #historyDisplay {
            background-color: #2d98ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            width: 100%;
            max-width: 500px;
            text-align: left;
            color: white;
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid white;
        }

        #historyDisplay h3 {
            margin-top: 0;
            color: white;
            font-family: 'Luckiest Guy', cursive;
            text-transform: uppercase;
            font-size: 18px;
        }

        #historyList {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #historyList li {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 14px;
        }

        #historyList li:last-child {
            border-bottom: none;
        }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
</head>
<body>
    <div class="wrapper">
        <div class="title">CONTROL PANEL</div>

        <div class="section-title">Set Exclusions</div>
        <div class="controls-grid">
            <div class="control-group">
                <label>Dice Colors:</label>
                <label class="red"><input type="checkbox" id="excludeRed" value="red"> Red</label>
                <label class="orange"><input type="checkbox" id="excludeOrange" value="orange"> Orange</label>
                <label class="gold"><input type="checkbox" id="excludeGold" value="gold"> Yellow</label>
                <label class="green"><input type="checkbox" id="excludeGreen" value="green"> Green</label>
                <label class="blue"><input type="checkbox" id="excludeBlue" value="blue"> Blue</label>
                <label class="purple"><input type="checkbox" id="excludePurple" value="purple"> Purple</label>
            </div>
            <div class="control-group">
                <label>Coin Faces:</label>
                <label class="heads"><input type="checkbox" id="excludeHeads" value="heads"> Heads</label>
                <label class="tails"><input type="checkbox" id="excludeTails" value="tails"> Tails</label>
            </div>
        </div>

        <button id="submitRigButton">Submit Rig</button> <!-- New button for submitting exclusions -->
        <button id="clearExclusionsButton">Clear All Exclusions</button>
        <button id="setRollingTrueButton">Set Rolling Status: TRUE</button>
        <button id="setRollingFalseButton">Set Rolling Status: FALSE</button>

        <div id="rollingStatus">Current Rolling Status: Not Rolling</div>

        <div id="historyDisplay">
            <h3>Roll History</h3>
            <ul id="historyList">
                <!-- History items will be appended here -->
            </ul>
        </div>
    </div>

    <script>
        // Firebase Configuration (Use your actual Firebase config)
        const firebaseConfig = {
            apiKey: "AIzaSyCX6bXyHJEdUFSZTq2tBqFYFYNv7FSxD8",
            authDomain: "color-game-135fb.firebaseapp.com",
            databaseURL: "https://color-game-135fb-default-rtdb.firebaseio.com",
            projectId: "color-game-135fb",
            storageBucket: "color-game-135fb.appspot.com",
            messagingSenderId: "362417900313",
            appId: "1:362417900313:web:765a79e4c95fa17936fa30"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const presetRef = db.ref("presetDice"); // Where excluded colors are stored
        const rollingRef = db.ref("isRolling"); // To indicate if a roll is in progress
        const historyRef = db.ref("history"); // To save roll history

        const checkboxes = document.querySelectorAll('.controls-grid input[type="checkbox"]');
        const rollingStatusDiv = document.getElementById('rollingStatus');
        const historyList = document.getElementById('historyList');

        let lastRollingStatus = false; // To detect changes in rolling status

        // Function to update Firebase with current exclusions
        function updateFirebaseExclusions() {
            const excludedItems = [];
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    excludedItems.push(checkbox.value);
                }
            });
            presetRef.set(excludedItems)
                .then(() => console.log("Exclusions updated in Firebase:", excludedItems))
                .catch(error => console.error("Error updating exclusions:", error));
        }

        // *** REMOVED: Checkboxes no longer update Firebase on change ***
        // checkboxes.forEach(checkbox => {
        //     checkbox.addEventListener('change', updateFirebaseExclusions);
        // });

        // Listen for changes in presetDice from Firebase and update checkboxes
        // This listener is still needed to sync the checkboxes when control.html loads
        // or if another control panel instance changes the exclusions.
        presetRef.on('value', (snapshot) => {
            const exclusions = snapshot.val() || [];
            checkboxes.forEach(checkbox => {
                checkbox.checked = exclusions.includes(checkbox.value);
            });
            console.log("Checkboxes updated from Firebase:", exclusions);
        });

        // New: Event listener for the "Submit Rig" button
        document.getElementById('submitRigButton').addEventListener('click', updateFirebaseExclusions);

        // Clear All Exclusions button
        document.getElementById('clearExclusionsButton').addEventListener('click', () => {
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateFirebaseExclusions(); // Push empty array to Firebase
        });

        // Manual Set Rolling Status buttons (for debugging/override)
        document.getElementById('setRollingTrueButton').addEventListener('click', () => {
            rollingRef.set(true)
                .then(() => console.log("isRolling set to TRUE"))
                .catch(error => console.error("Error setting isRolling to TRUE:", error));
        });

        document.getElementById('setRollingFalseButton').addEventListener('click', () => {
            rollingRef.set(false)
                .then(() => console.log("isRolling set to FALSE"))
                .catch(error => console.error("Error setting isRolling to FALSE:", error));
        });

        // Listen for rolling status changes from index.html
        rollingRef.on('value', (snapshot) => {
            const isRolling = snapshot.val();
            rollingStatusDiv.textContent = `Current Rolling Status: ${isRolling ? 'ROLLING...' : 'Not Rolling'}`;
            rollingStatusDiv.style.color = isRolling ? 'red' : 'white';

            // Implement the "exclusion reset per roll" logic
            if (lastRollingStatus === true && isRolling === false) {
                // Roll just finished, clear exclusions
                console.log("Roll finished, clearing exclusions...");
                // Use a small delay to ensure index.html has fully processed the 'false' status
                // before control.html clears the exclusions. This helps prevent race conditions.
                setTimeout(() => {
                    document.getElementById('clearExclusionsButton').click(); // Simulate click to clear
                }, 100); // 100ms delay
            }
            lastRollingStatus = isRolling; // Update last status
        });

        // Listen for roll history
        historyRef.limitToLast(10).on('child_added', (snapshot) => {
            const rollData = snapshot.val();
            const listItem = document.createElement('li');
            let resultText = '';

            if (rollData.type === 'dice') {
                resultText = `Dice Roll: ${rollData.results.join(', ')}`;
            } else if (rollData.type === 'coin') {
                resultText = `Coin Flip: ${rollData.results.join(', ')}`;
            } else {
                resultText = `Unknown Roll: ${JSON.stringify(rollData.results)}`;
            }

            // Use Firebase's push key as a timestamp for sorting/display
            const timestamp = new Date(parseInt(snapshot.key)).toLocaleTimeString();
            listItem.textContent = `[${timestamp}] ${resultText}`;
            historyList.prepend(listItem); // Add to the top

            // Keep only the last 10 items
            while (historyList.children.length > 10) {
                historyList.removeChild(historyList.lastChild);
            }
        });

        // Initial sync of checkboxes with Firebase on load
        window.onload = () => {
            presetRef.once('value', (snapshot) => {
                const exclusions = snapshot.val() || [];
                checkboxes.forEach(checkbox => {
                    checkbox.checked = exclusions.includes(checkbox.value);
                });
            });
        };
    </script>
</body>
</html>
